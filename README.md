# gatsby-node-helpers

Gatsby node helper functions to aid node creation. To be used when creating
[Gatsby source plugins][gatsby-source-plugins].

## Status

[![npm version](https://badge.fury.io/js/gatsby-node-helpers.svg)](http://badge.fury.io/js/gatsby-node-helpers)
[![Build Status](https://secure.travis-ci.org/angeloashmore/gatsby-node-helpers.svg?branch=master)](http://travis-ci.org/angeloashmore/gatsby-node-helpers?branch=master)

## Installation

```sh
npm install --save gatsby-node-helpers
```

## Quick Guide

### Import

Import the default module:

```js
import createNodeHelpers from 'gatsby-node-helpers'
```

### Create node helpers

Call `createNodeHelpers` with options.

```js
import createNodeHelpers from 'gatsby-node-helpers'

const {
  createNodeFactory,
  generateNodeId,
  generateTypeName,
} = createNodeHelpers({
  typePrefix: `Shopify`,
})
```

### Create a node factory

Call `createNodeFactory` with a type name.

```js
import createNodeHelpers from 'gatsby-node-helpers'

const {
  createNodeFactory,
  generateNodeId,
  generateTypeName,
} = createNodeHelpers({
  typePrefix: `Shopify`,
})

export const ProductNode = createNodeFactory(`Product`)
```

### Use the node factory in your `gatsby-node.js`

`ProductNode` accepts an object and returns a new object to be passed to
Gatsby's `createNode` action creator.

It handles setting up Gatsby's internal fields, including the content digest and
node type.

```js
// gatsby-node.js

import { ProductNode } from './nodes'
import { getAllProducts } from './api'

exports.sourceNodes = async ({ boundActionCreators }) => {
  const { createNode } = boundActionCreators

  const products = await getAllProducts()

  products.forEach(product => {
    const node = ProductNode(product)
    createNode(node)
  })
}
```

## API

### `createNodeHelpers`

The default export of the package. This function takes in a map of options and
outputs three helper functions:

* `createNodeFactory`
* `generateNodeId`
* `generateTypeName`

The following options are available:

| Name                  | Default                 | Required | Description                                                                               |
| --------------------- | ----------------------- | -------- | ----------------------------------------------------------------------------------------- |
| `sourceId`            | `__SOURCE__`            | no       | Default source parent ID. Understood as a top-level node.                                 |
| `typePrefix`          |                         | **yes**  | Prefix for all nodes. Used a namespace for node type names and IDs. Should be PascalCase. |
| `conflictFieldPrefix` | Camelcased `typePrefix` | no       | Prefix for fields conflicting with Gatsby's internal fields.                              |

The following functions are generated by `createNodeHelpers`.

### `createNodeFactory`

Creates a factory function that takes in an object and outputs a Gatsby
`createNode` compatible object.

By default, the input object is kept intact, with the following exceptions:

* Fields conflicting with Gatsby's internal fields are prefixed.
* `obj.id` is set to a generated string containing `typePrefix` set in
  `createNodeHelpers`, `type` set in the factory function, and `obj.id`
* `obj.parent` is set to `sourceId` set in `createNodeHelpers` (`__SOURCE__` by
  default)
* `obj.children` is set to `[]` by default
* `obj.internal.type` is set to a generated string containing `typePrefix` set
  in `createNodeHelpers` and `type` set in the factory function
* `obj.internal.contentDigest` is set to the MD5 hash of the object including
  Gatsby's internal fields.

A middleware function can be provided to modify the node beyond these
exceptions. This can be used, for example, to set `obj.children`. The middleware
function is passed the modified object and must return a Gatsby-comptabible
object.

The resulting function of `createNodeFactory` can take in an object and an
overrides object. This can be used, for example, to set `obj.parent`. The
overrides object is merged with the modified object using `Object.assign`; no
mutations are performed, so be careful with what you set.

### `generateNodeId`

Creates a function that takes in a node type and node ID and returns a formatted
string. It is used internally to create a node's ID, but it can be useful when
setting `obj.parent` and `obj.children` in a middleware function or overrides
object.

### `generateTypeName`

Creates a function that takes in a node type and returns a formatted string. It
is used internally to create a node's type name.

#### Type signature

```js
(options: {
  sourceId?: String,
  typePrefix: String,
  conflictFieldPrefix?: String
  }) => {
  createNodeFactory: (type: String, middleware: )
}
```

[gatsby-source-plugins]: https://www.gatsbyjs.org/docs/create-source-plugin/
